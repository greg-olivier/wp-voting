<?phpdefined( 'ABSPATH' ) or die();add_shortcode('WP_VOTING', 'wp_voting_add_shortcode');function wp_voting_add_shortcode($atts, $content = null){     $args = array(        'post_type' => array('wp_voting_contest'),        'post_status' => array('publish'),        'nopaging' => true,        'order' => 'ASC',        'orderby' => 'date',        'p' => $atts[0]    );// The Query    $wp_voting_post_query = new WP_Query($args);// The Loop    if ($wp_voting_post_query->have_posts()) {        $str = '<div class="wp_voting wp_voting_container">';        $str .= '<div class="wp_voting_inner">';        while ($wp_voting_post_query->have_posts()) {            $wp_voting_post_query->the_post();            $wp_voting_item_videos = get_url_wp_voting_items_video(get_the_id())[get_the_id()];            $wp_voting_item_names = get_post_meta(get_the_id(), 'wp_voting_contest_item', true);            $wp_voting_item_imgs = get_post_meta(get_the_id(), 'wp_voting_contest_item_img', true);            $wp_voting_item_descs = get_post_meta(get_the_id(), 'wp_voting_contest_item_desc', true);            $wp_voting_item_profil_options = get_post_meta(get_the_id(), 'wp_voting_contest_item_profil_option', true);            $wp_voting_item_subtitles = get_post_meta(get_the_id(), 'wp_voting_contest_item_subtitle', true);            $wp_voting_contest_start_date = (int)strtotime(get_post_meta(get_the_id(), 'wp_voting_contest_start_date', true));            $wp_voting_contest_end_date = (int)strtotime(get_post_meta(get_the_id(), 'wp_voting_contest_end_date', true));            $wp_voting_contest_item_id = get_post_meta(get_the_id(), 'wp_voting_contest_item_id', true);            $wp_voting_contest_vote_total_count = (int)get_post_meta(get_the_id(), 'wp_voting_vote_total_count', true);            $wp_voting_actual_date = (int)date_timestamp_get(new DateTime());            $wp_voting_nb_items = count($wp_voting_item_names);            // IDENTIFICATION BY IP            $wp_voting_contest_ip_users = get_post_meta(get_the_id(), 'wp_voting_contest_ip_users', true);            $ip_user = $_SERVER['REMOTE_ADDR'];            $str .= '<div class="wp_voting_container wp_voting_contest-id wp_voting_contest-' . get_the_id() . '">            <h1 class="wp_voting_title"><span>' . get_the_title() . '</span></h1>            <div class="wp_voting_grid wp_voting_survey-stage">';            if ($wp_voting_actual_date >= $wp_voting_contest_end_date) {                $str .= '<span class="wp_voting_stage wp_voting_ended wp_voting_active">Votes clos</span>';            } elseif ($wp_voting_contest_start_date >= $wp_voting_actual_date) {                $str .= '<span class="wp_voting_stage wp_voting_ended wp_voting_active">Votes bientôt ouverts</span>';                // IDENTIFICATION BY COOKIES                //} elseif(isset($_COOKIE['wp_voting_id-'.get_the_id()]) && $_COOKIE['wp_voting_id-'.get_the_id()] == get_the_id()) {                // $str .= '<span class="wp_voting_stage wp_voting_ended wp_voting_active">Vous avez déjà voté pour cette catégorie</span>';                //}                // IDENTIFICATION BY IP            } else {                if ($wp_voting_contest_ip_users) {                    foreach ($wp_voting_contest_ip_users as $wp_voting_contest_ip_user) {                        if ($wp_voting_contest_ip_user == $ip_user) {                            $str .= '<span class="wp_voting_stage wp_voting_ended wp_voting_active">Vous avez déjà voté pour cette catégorie</span>';                        }                    }                }            }            $str .= '</div>            <div class="wp_voting_inner">            <ul class="wp_voting_grid">';                        $n = 1;            $i = 0;            foreach ($wp_voting_item_names as $wp_voting_item_name) {                $str .= '<li class="wp_voting_survey-item">                <div class="wp_voting_survey-item-inner">';                if ($wp_voting_item_imgs[$i]) {                    $str .= '<div class="wp_voting_survey-country" style="background-image:url(' . $wp_voting_item_imgs[$i] . ')">';                    $str .= '</div>';                }                $str .= '<div class="wp_voting_survey-box-under">                <div class="wp_voting_infos">                <div class="wp_voting_survey-name">                ' . $wp_voting_item_name . '                </div>                <div class="wp_voting_survey-subtitle">' . $wp_voting_item_subtitles[$i] . '</div>';                $str .= '<div class="wp_voting_survey-extract">' . wp_voting_item_synopsis($wp_voting_item_descs[$i]) . '</div>                </div>';                if ($wp_voting_contest_start_date <= $wp_voting_actual_date && $wp_voting_actual_date <= $wp_voting_contest_end_date) {                    $str .= '<div class="wp_voting_survey-item-action"> ';                    $str .= '<div class="wp_voting_item-action wp_voting_survey-profil">                    <button data-open="profil-' . get_the_id() . $n . '" class="wp_voting_button wp_voting_survey-profil-button">Voir le profil</button></div>';                    // IDENTIFICATION BY IP                    if ($wp_voting_contest_ip_users) {                        foreach ($wp_voting_contest_ip_users as $wp_voting_contest_ip_user) {                            if ($wp_voting_contest_ip_user == $ip_user)                                $vote_registred = true;                        }                    }                    if ($vote_registred !== true) {                        $str .= '<form action="" name="" class="wp_voting_survey-item-action-form wp_voting_item-action">                        <input type="hidden" name="wp_voting_contest-id" id="wp_voting_contest-id" value="' . get_the_id() . '">                        <input type="hidden" name="wp_voting_survey-item-id" id="wp_voting_survey-item-id" value="' . $wp_voting_contest_item_id[$i] . '">                        <input type="button" class="wp_voting_button" name="wp_voting_survey-vote-button-' . get_the_id() . $n . '" id="wp_voting_survey-vote-button" value="Je vote">                        </form>                        </div>';                        // IDENTIFICATION BY COOKIES                        // if (!isset($_COOKIE['wp_voting_id-'.get_the_id()]) || $_COOKIE['wp_voting_id-'.get_the_id()] != get_the_id()) {                        //  $str .= '<form action="" name="" class="wp_voting_survey-item-action-form">                        //  <input type="hidden" name="wp_voting_contest-id" id="wp_voting_contest-id" value="' . get_the_id() . '">                        //  <input type="hidden" name="wp_voting_survey-item-id" id="wp_voting_survey-item-id" value="' . $wp_voting_contest_item_id[$i] . '">                        //  <input type="button" class="wp_voting_button" name="wp_voting_survey-vote-button-' . get_the_id().$n . '" id="wp_voting_survey-vote-button" value="Je vote">                        //  </form>                        //  </div>';                    } else {                        $str .= '</div>';                    }                } else {                    $str .= '<div class="wp_voting_survey-item-action">                    <div class="wp_voting_item-action wp_voting_survey-profil">                    <button data-open="profil-' . get_the_id() . $n . '" class="wp_voting_button wp_voting_survey-profil-button">Voir le profil</button>                    </div>                    </div>';                }                $str .= '                <div class="wp_voting_pop-in">                <div class="wp_voting_modal wp_voting_contest-' . get_the_id() . '" id="profil-' . get_the_id() . $n . '">                <button class="wp_voting_modal-close-button" data-close aria-label="Close modal" type="button">                <span aria-hidden="true">&times;</span>                </button>                <div class="wp_voting_modal-item">                <div class="wp_voting_modal-item-inner">';                if ($wp_voting_item_profil_options[$i] == 'img') {                   if ($wp_voting_item_imgs[$i]) {                    $str .= '<div class="wp_voting_modal-container-img">                    <div class="wp_voting_modal-img" style="background-image:url(' . $wp_voting_item_imgs[$i] . ')">                    </div>                    </div>                    <div class="wp_voting_modal-content">';                }            } else if ($wp_voting_item_profil_options[$i] == 'yt'){                if ($wp_voting_item_videos[$i]) {                    // $str .= '<div class="wp_voting_modal-container-yt">                    // <div class="wp_voting_modal-yt">                    // <a class="wp_voting_play-video wp_voting_video-'. get_the_id() . $n .'">                    // <div class="wp_voting_modal_video" id="wp_voting_video-'. get_the_id() . $n .'"></div>';                    // $location_id = strpos($wp_voting_item_videos[$i], '=') + 1;                    // $id_yt_video = substr($wp_voting_item_videos[$i], $location_id);                    // $str .= '                    // <div class="wp_voting_thumbnail-yt">                    // <img src="https://i.ytimg.com/vi/iX30BzcHMTA/sddefault.jpg">                    // <div class="player-video"></div>                    // </div>                    // </a>                 $str .= '<div class="wp_voting_modal-container-yt">                 <div class="wp_voting_modal-yt">                 <div class="wp_voting_modal_video" id="wp_voting_video-'. get_the_id() . $n .'"></div>                 </div>                 </div>                 <div class="wp_voting_modal-content">';             }         } else {            $str .= '<div class="wp_voting_modal-content">';        }        $str .= '<h1 class="wp_voting_modal-title">' . $wp_voting_item_name . '</h5>        <h2 class="wp_voting_modal-subtitle">' . $wp_voting_item_subtitles[$i] . '</h2>';        $str .= '<p class="wp_voting_modal-description">' . $wp_voting_item_descs[$i] . '</p>';        if ($wp_voting_contest_start_date <= $wp_voting_actual_date && $wp_voting_actual_date <= $wp_voting_contest_end_date) {                    // IDENTIFICATION BY COOKIES                    // $str .= '<button id="votin" class="wp_voting_button-modal';                    // if (isset($_COOKIE['wp_voting_id-'.get_the_id()]) && $_COOKIE['wp_voting_id-'.get_the_id()] == get_the_id())                    //     $str .= ' wp_voting_survey-item-action-disabled';                    // IDENTIFICATION BY IP            if ($wp_voting_contest_ip_users) {                foreach ($wp_voting_contest_ip_users as $wp_voting_contest_ip_user) {                    if ($wp_voting_contest_ip_user == $ip_user)                        $vote_registred = true;                }            }            if ($vote_registred !== true)                $str .= '<button id="votin" class="wp_voting_button-modal" data-rel="' . get_the_id() . $n . '">Je vote pour ce candidat</button>';        }        $str .= '</div>        </div>        </div>        </div>        </div>';        $str .= '        </div>        </div>        </li>';        if ($n !== 3 && $wp_voting_nb_items != $n)            $str .= '<img class="wp_voting_separator" src="/wp-content/themes/nextiawp/assets/img/filet_dore.png" alt="Séparateur" width="1" height="212">';        $i++;        $n++;    };    $str .= '</ul>      </div>    <div class="wp_voting_processing">En cours..</div>    <div class="wp_voting_fail">Vous avez déjà voté pour cette catégorie</div>    <div class="wp_voting_success">Merci, votre vote a bien été enregistré</div>    </div>    </div>    </div>';//     $str .= '<script>//         // get .player nodes//     var playerDivs = document.querySelectorAll(".player");// // nodelist to array to use forEach();//     var playerDivsArr = [].slice.call(playerDivs);//     var players = new Array(playerDivsArr.length);//     var waypoints = new Array(playerDivsArr.length);// // when youtube stuff is ready//     function onYouTubeIframeAPIReady() {//   // create yt players//       playerDivsArr.forEach(function(e, i) { // forEach ...//         players[i] = new YT.Player(e.id, {//             height: "450",//             width: "800",//             videoId: "M7lc1UVf-VE",//         events: { /* no events set */ },//         playerVars: {//             autoplay: 0,//             rel: 0,//             showinfo: 0//         }//     })// })//   // create waypoints// $(".player").each(function(i, e) {//     waypoints[i] = new Waypoint({//         element: e,//         handler: function() {//             players[i].playVideo();//         }//     })// });// }// </script>'    //     <script>    //     var tag = document.createElement("script");    //     tag.src = "https://www.youtube.com/iframe_api";    //     tag.id = "youtube_api"    //     if (document.getElementById(tag.id) == null){    //     var firstScriptTag = document.getElementsByTagName("script")[0];    //     firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);    //     }    //   // 3. This function creates an <iframe> (and YouTube player)    //   //    after the API code downloads.    //     var player,    //     w = window,    //     d = document,    //     e = d.documentElement,    //     g = d.getElementsByTagName("body")[0],    //     x = w.innerWidth || e.clientWidth || g.clientWidth;    //     function onYouTubeIframeAPIReady() {    //         if (x <= 900) {    //         player = new YT.Player("wp_voting_video-4412", {    //           height: "360",    //           width: "640",    //           videoId: "iX30BzcHMTA",    //           playerVars: {    //             autoplay: 0,    //             rel: 0,    //             showinfo: 0    //         },    //         events: {    //             "onReady": resizeVideo,    //             "onStateChange": onPlayerStateChange    //         }    //     });    // } else {    //      player = new YT.Player("wp_voting_video-4412", {    //           height: "450",    //           width: "800",    //           videoId: "iX30BzcHMTA",    //           playerVars: {    //             autoplay: 0,    //             rel: 0,    //             showinfo: 0    //         },    //         events: {    //             "onReady": resizeVideo,    //             "onStateChange": onPlayerStateChange    //         }    //     });    // }    // }    //   // 4. The API will call this function when the video player is ready.    // function onPlayerReady(event) {    //     event.target.playVideo();    // }    //   // 5. The API calls this function when the players state changes.    //   //    The function indicates that when playing a video (state=1),    //   //    the player should play for six seconds and then stop.    // var done = false;    // function onPlayerStateChange(event) {    //     if (event.data == YT.PlayerState.ENDED && !done) {    //         stopVideo();    //         done = true;    //     }    // }    // function stopVideo() {    //     player.stopVideo();    //     $(".wp_voting_thumbnail-yt").fadeIn("normal");    //     $("#wp_voting_video-4412").hide();    // }    // $(".wp_voting_play-video").click(function () {    //     $(this).find(".wp_voting_thumbnail-yt").hide();    //     $("#wp_voting_video-4412").show();    //     player.playVideo();    // });    // </script>';}} else {}// Restore original Post Datawp_reset_postdata();return $str;}add_filter('widget_text', 'do_shortcode');add_filter('content', 'do_shortcode');